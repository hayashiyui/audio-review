---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import ReviewsCard from '@/components/ReviewsCard.astro'
import Layout from '@/layouts/Layout.astro'
import { getAllReviewCategories, getReviewsByCategory, groupReviewsByYear } from '@/lib/data-utils'

export async function getStaticPaths() {
  const categoryMap = await getAllReviewCategories()
  const categories = Array.from(categoryMap.keys())

  return Promise.all(
    categories.map(async (category) => {
      const all = await getReviewsByCategory(category)
      const reviews = all.filter((r) => (r.data.locale ?? 'ja') === 'ja')
      return {
        params: { category },
        props: {
          category,
          reviews,
        },
      }
    }),
  )
}

const { category, reviews } = Astro.props
const reviewsByYear = groupReviewsByYear(reviews)
---

<Layout class="max-w-6xl ml-2">
  <PageHead
    slot="head"
    title={`${category} - オーディオレビュー`}
    description={`${category}カテゴリのオーディオ機器レビュー一覧`}
  />
  <div data-pagefind-ignore="all">
    <Breadcrumbs
      items={[
        { href: '/reviews', label: 'オーディオレビュー', icon: 'lucide:headphones' },
        { label: category, icon: 'lucide:tag' },
      ]}
    />

    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-2">{category}</h1>
      <p class="text-muted-foreground">
        {reviews.length} 件のレビュー
      </p>
    </header>

    {Object.entries(reviewsByYear)
      .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
      .map(([year, yearReviews]) => (
        <section class="mb-8">
          <h2 class="mb-4 text-xl font-semibold">{year}</h2>
          <ul class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
            {yearReviews.map((review) => (
              <li>
                <ReviewsCard entry={review} />
              </li>
            ))}
          </ul>
        </section>
      ))}
  </div>
</Layout>
